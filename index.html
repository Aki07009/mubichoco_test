<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ãƒ ãƒ“ãƒãƒ§ã‚³</title>
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Kosugi+Maru&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Kosugi Maru', sans-serif;
    margin: 18px;
    max-width: 1000px;
    background: #ffffff;
    color: #333;
  }
  h1 {
    background: linear-gradient(90deg, #4da0ff, #1e90ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 2em;
    margin-bottom: 18px;
  }

  .tabs {
    display: flex;
    border-bottom: 2px solid #ccc;
    margin-bottom: 12px;
  }
  .tab {
    padding: 10px 16px;
    cursor: pointer;
    border: 1px solid #ccc;
    border-bottom: none;
    background: #f0f8ff;
    margin-right: 4px;
    border-radius: 6px 6px 0 0;
    transition: 0.3s;
  }
  .tab.active { background: #fff; font-weight: bold; color: #1e90ff; }
  .tab:hover { background: #e6f0ff; }
  .tabContent { display: none; }
  .tabContent.active { display: block; }

  /* ã‚«ãƒ¼ãƒ‰å…±é€š */
  .cards-container {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }
  .movie {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    padding: 10px;
    width: 130px;
  }
  .movie img {
    width: 100%;
    height: auto;
    aspect-ratio: 2 / 3;
    border-radius: 8px;
    margin-bottom: 8px;
    object-fit: cover;
  }
  .movie .no-image {
    width: 100%;
    aspect-ratio: 2 / 3;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #eee;
    color: #888;
    font-size: 0.9em;
    border-radius: 8px;
    margin-bottom: 8px;
    text-align: center;
  }
  .movie a {
    font-weight: bold;
    color: #333;
    text-decoration: none;
    text-align: center;
    margin-bottom: 6px;
    display: block;
    word-break: break-word;
  }
  .movie .status-label {
    font-size: 0.85em;
    color: #555;
    margin-bottom: 6px;
    text-align: center;
  }
  .movie button {
    cursor: pointer;
    background:#1e90ff;
    border:none;
    color:white;
    padding:6px 12px;
    border-radius:6px;
    font-weight:bold;
    transition: all 0.2s ease;
  }
  .movie button:hover { background:#187bcd; }

  /* ãƒ©ãƒ³ãƒ€ãƒ ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ— */
  .random-box {
    background: linear-gradient(135deg, #d6f0ff, #e0f5ff);
    border-radius: 12px;
    padding: 24px;
    margin: 36px 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .random-box h3 {
    font-size: 1.4em;
    color: #1e90ff;
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #btnRandom {
    background: white;
    border: 2px solid #1e90ff;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top:8px;
  }
  #btnRandom:hover {
    background: linear-gradient(90deg, #4da0ff, #1e90ff);
    color: white;
    transform: scale(1.05);
  }

  /* è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */
  #addForm {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
  }
  #addForm label { font-weight: bold; }
  #addForm input {
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: #e6f2ff;
  }
  #addForm button {
    margin-top: 12px;
    padding: 8px;
    border: none;
    background: #1e90ff;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }
  #addForm button:hover { background: #187bcd; }
</style>
</head>
<body>
<h1>ğŸ¬ãƒ ãƒ“ãƒãƒ§ã‚³ğŸ«</h1>

<div class="tabs">
  <div class="tab active" data-tab="want">è¦³ãŸã„ãƒªã‚¹ãƒˆ</div>
  <div class="tab" data-tab="watched">è¦³ãŸãƒªã‚¹ãƒˆ</div>
  <div class="tab" data-tab="add">è¿½åŠ </div>
  <div class="tab" data-tab="settings">è¨­å®š</div>
</div>

<div id="want" class="tabContent active">
  <br>
  <h2>ğŸ¿è¦³ãŸã„ãƒªã‚¹ãƒˆ</h2>
  <div class="random-box">
    <h3>ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
      <select id="filterStatus">
        <option value="">å…¨éƒ¨</option>
        <option value="ç„¡æ–™">ç„¡æ–™</option>
        <option value="æœ‰æ–™">æœ‰æ–™</option>
      </select>
    </label>
    <label>ã‚¸ãƒ£ãƒ³ãƒ«:
      <select id="filterGenre"><option value="">å…¨éƒ¨</option></select>
    </label>
    <br>
    <button id="btnRandom">ãƒ©ãƒ³ãƒ€ãƒ ã§é¸ã¶</button>
    <div id="randomResult" style="margin-top:12px;"></div>
  </div>

  <div id="wantList" class="cards-container">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="watched" class="tabContent">
  <br>
  <h2>âœ…è¦³ãŸãƒªã‚¹ãƒˆ</h2>
  <div id="watchedList" class="cards-container">èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<div id="add" class="tabContent">
  <br>
  <h2>â•è¿½åŠ </h2>
  <form id="addForm">
    <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
    <input type="text" id="title" required />
    <label>URL</label>
    <input type="text" id="url" />
    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
    <input type="text" id="status" placeholder="æœ‰æ–™/ç„¡æ–™ãªã©" />
    <label>ã‚¸ãƒ£ãƒ³ãƒ«</label>
    <input type="text" id="genre" />
    <button type="submit">è¿½åŠ </button>
  </form>
  <div id="addMsg" class="status"></div>
</div>

<div id="settings" class="tabContent">
  <br>
  <h2>âš™è¨­å®š</h2>
  <label>API URL: <input type="text" id="apiUrlInput" style="width:80%" /></label>
  <button id="saveApi">ä¿å­˜</button>
  <div id="saveMsg" class="status"></div>
</div>

<script>
let API = localStorage.getItem('mubichoco_api') || '';
let allMovies = [];

function setStatus(msg){ document.getElementById('addMsg').innerText = msg; }
async function getJSON(url){
  try { return await (await fetch(url)).json(); } catch(e){ console.error(e); return null; }
}

// è¦³ãŸã„ãƒªã‚¹ãƒˆ
async function loadWant(){
  if(!API){ document.getElementById('wantList').innerText="APIæœªè¨­å®š"; return; }
  const data = await getJSON(API+'?action=list');
  if(!data){ document.getElementById('wantList').innerText="èª­ã¿è¾¼ã¿å¤±æ•—"; return; }
  allMovies = data;

  const genreSelect = document.getElementById('filterGenre');
  const genres = Array.from(new Set(data.map(m=>m.genre||"æœªåˆ†é¡")));
  genreSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
  genres.forEach(g=>{ genreSelect.innerHTML += `<option value="${g}">${g}</option>`; });

  const grouped = {};
  data.forEach(m => {
    const g = m.genre || "æœªåˆ†é¡";
    if(!grouped[g]) grouped[g]=[];
    grouped[g].push(m);
  });

  const container=document.getElementById('wantList');
  container.innerHTML='';
  const colors=["#d6f0ff","#d6f5ff","#d6ffd8","#fff3d6","#e0f5ff","#e0f0ff"];
  let colorIndex=0;

  Object.keys(grouped).forEach(g=>{
    const block=document.createElement('div');
    block.className='genre-block';
    block.style.background=colors[colorIndex%colors.length];
    colorIndex++;
    block.innerHTML=`<h3>${g}</h3>`;

    const cardsContainer = document.createElement('div');
    cardsContainer.className='cards-container';

    grouped[g].forEach(m=>{
      const d=document.createElement('div');
      d.className='movie';
      d.innerHTML=`
        ${m.poster ? `<img src="${m.poster}" alt="${m.title}" onerror="this.style.display='none'"><div class="no-image" style="display:none">No image</div>` 
                    : `<div class="no-image">No image</div>`}
        <a href="${m.url||'#'}" target="_blank">${m.title}</a>
        <div class="status-label">${m.status||''}</div>
        <button>è¦³ãŸï¼</button>
      `;
      const img = d.querySelector('img');
      const noImg = d.querySelector('.no-image');
      if(img) img.onerror = ()=>{ img.style.display='none'; noImg.style.display='flex'; };

      d.querySelector('button').onclick=async()=>{
        await getJSON(API+`?action=watched&title=${encodeURIComponent(m.title)}`);
        loadWant(); loadWatched();
      };
      cardsContainer.appendChild(d);
    });

    block.appendChild(cardsContainer);
    container.appendChild(block);
  });
}

// è¦³ãŸãƒªã‚¹ãƒˆ
async function loadWatched(){
  if(!API){ document.getElementById('watchedList').innerText="APIæœªè¨­å®š"; return; }
  const data = await getJSON(API+'?action=watchedList');
  if(!data){ document.getElementById('watchedList').innerText="èª­ã¿è¾¼ã¿å¤±æ•—"; return; }

  const container = document.getElementById('watchedList');
  container.innerHTML = '';

  data.forEach(m=>{
    const d=document.createElement('div');
    d.className='movie';
    d.innerHTML=`
      ${m.poster ? `<img src="${m.poster}" alt="${m.title}" onerror="this.style.display='none'"><div class="no-image" style="display:none">No image</div>` 
                  : `<div class="no-image">No image</div>`}
      <a href="${m.url||'#'}" target="_blank">${m.title}</a>
      <div class="status-label">${m.status||''}</div>
      <div class="status-label">è¦³ãŸæ—¥: ${m.watchedDate ? new Date(m.watchedDate).toLocaleDateString() : ''}</div>
    `;
    const img = d.querySelector('img');
    const noImg = d.querySelector('.no-image');
    if(img) img.onerror = ()=>{ img.style.display='none'; noImg.style.display='flex'; };

    container.appendChild(d);
  });
}

// ãƒ©ãƒ³ãƒ€ãƒ 
document.getElementById('btnRandom').onclick = () => {
  if(!allMovies.length){ document.getElementById('randomResult').innerText="ãƒªã‚¹ãƒˆãŒç©ºã§ã™"; return; }
  const statusFilter = document.getElementById('filterStatus').value;
  const genreFilter = document.getElementById('filterGenre').value;
  let filtered = allMovies;
  if(statusFilter) filtered = filtered.filter(m => m.status === statusFilter);
  if(genreFilter) filtered = filtered.filter(m => m.genre === genreFilter);
  if(!filtered.length){ document.getElementById('randomResult').innerText="æ¡ä»¶ã«åˆã†æ˜ ç”»ãŒã‚ã‚Šã¾ã›ã‚“"; return; }
  const choice = filtered[Math.floor(Math.random()*filtered.length)];
  document.getElementById('randomResult').innerHTML = `ğŸ‘‰ <a href="${choice.url||'#'}" target="_blank">${choice.title}</a> [${choice.status||''}]`;
};

// è¿½åŠ 
document.getElementById('addForm').onsubmit=async(e)=>{
  e.preventDefault();
  if(!API){ setStatus("APIæœªè¨­å®š"); return; }
  const title=document.getElementById('title').value;
  const url=document.getElementById('url').value;
  const status=document.getElementById('status').value;
  const genre=document.getElementById('genre').value;
  await getJSON(API+`?action=add&title=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}&status=${encodeURIComponent(status)}&genre=${encodeURIComponent(genre)}`);
  setStatus("âœ… è¿½åŠ ã•ã‚Œã¾ã—ãŸï¼");
  document.getElementById('addForm').reset();
  loadWant();
};

// APIä¿å­˜
document.getElementById('saveApi').onclick=()=>{
  const val=document.getElementById('apiUrlInput').value.trim();
  if(val){
    localStorage.setItem('mubichoco_api',val);
    API=val;
    document.getElementById('saveMsg').innerText="âœ… ä¿å­˜ã—ã¾ã—ãŸ";
    loadWant(); loadWatched();
  }
};

// ã‚¿ãƒ–åˆ‡æ›¿
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const target=tab.dataset.tab;
    document.querySelectorAll('.tabContent').forEach(c=>c.classList.remove('active'));
    document.getElementById(target).classList.add('active');
  });
});

document.getElementById('apiUrlInput').value=API;
if(API){ loadWant(); loadWatched(); }
</script>
</body>
</html>
